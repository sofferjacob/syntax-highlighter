<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>Syntax Highlighter</title>
</head>
<body>
    <h1>Syntax Highlighter</h1>
    <h3>Jacobo Soffer Levy | A01028653</h3>
    <h4>Date 2022-05-23 01:47:33.355678</h3>
    <pre>
<span class="kw">package </span><span class="vr">routes
</span><span>
</span><span class="kw">import </span><span class="vr"><span class="op">(</span>
</span><span>	</span><span class="st">"bytes"</span><span>
</span><span>	</span><span class="st">"context"</span><span>
</span><span>	</span><span class="st">"encoding/json"</span><span>
</span><span>	</span><span class="st">"fmt"</span><span>
</span><span>	</span><span class="st">"io/ioutil"</span><span>
</span><span>	</span><span class="st">"net/http"</span><span>
</span><span>	</span><span class="st">"net/url"</span><span>
</span><span>	</span><span class="st">"os"</span><span>
</span><span>
</span><span>	</span><span class="st">"github.com/gin-gonic/gin"</span><span>
</span><span>	</span><span class="st">"github.com/jkomyno/nanoid"</span><span>
</span><span>	</span><span class="st">"github.com/sofferjacob/dashboard_api/db"</span><span>
</span><span>	</span><span class="st">"github.com/sofferjacob/dashboard_api/ent"</span><span>
</span><span>	</span><span class="st">"github.com/sofferjacob/dashboard_api/ent/googleoauthstate"</span><span>
</span><span>	</span><span class="st">"github.com/sofferjacob/dashboard_api/ent/project"</span><span>
</span><span>	</span><span class="st">"github.com/sofferjacob/dashboard_api/ent/source"</span><span>
</span><span>	</span><span class="st">"github.com/sofferjacob/dashboard_api/tokens"</span><span>
</span><span class="vr"><span class="op">)</span>
</span><span>
</span><span class="kw">func </span><span class="vr">GetProjectSources<span class="op">(</span></span><span class="vr">c </span><span class="vr"><span class="op">*</span></span><span class="vr">gin<span class="op">.</span></span><span class="vr">Context<span class="op">)</span> </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	claimsObj<span class="op">,</span> </span><span class="vr">ok </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">c<span class="op">.</span></span><span class="vr">Get<span class="op">(</span></span><span class="st">"project-claims"</span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr"><span class="op">!</span></span><span class="vr">ok </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"missing claims"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	claims<span class="op">,</span> </span><span class="vr">ok </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">claimsObj<span class="op">.</span></span><span class="vr"><span class="op">(</span></span><span class="vr"><span class="op">*</span></span><span class="vr">tokens<span class="op">.</span></span><span class="vr">ProjectToken<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr"><span class="op">!</span></span><span class="vr">ok </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"invalid claims"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	sources<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">db<span class="op">.</span></span><span class="vr">Client<span class="op">.</span></span><span class="vr">Source<span class="op">.</span></span><span class="vr">Query<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">Where<span class="op">(</span></span><span class="vr">source<span class="op">.</span></span><span class="vr">SourceProject<span class="op">(</span></span><span class="vr">claims<span class="op">.</span></span><span class="vr">ProjectId<span class="op">)</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">All<span class="op">(</span></span><span class="vr">context<span class="op">.</span></span><span class="vr">Background<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">200<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"status"</span><span class="vr"><span class="op">:</span> </span><span class="st">"ok"</span><span class="vr"><span class="op">,</span> </span><span class="st">"sources"</span><span class="vr"><span class="op">:</span> </span><span class="vr">sources<span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">func </span><span class="vr">DeleteSource<span class="op">(</span></span><span class="vr">c </span><span class="vr"><span class="op">*</span></span><span class="vr">gin<span class="op">.</span></span><span class="vr">Context<span class="op">)</span> </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	claimsObj<span class="op">,</span> </span><span class="vr">ok </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">c<span class="op">.</span></span><span class="vr">Get<span class="op">(</span></span><span class="st">"project-claims"</span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr"><span class="op">!</span></span><span class="vr">ok </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"missing claims"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	claims<span class="op">,</span> </span><span class="vr">ok </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">claimsObj<span class="op">.</span></span><span class="vr"><span class="op">(</span></span><span class="vr"><span class="op">*</span></span><span class="vr">tokens<span class="op">.</span></span><span class="vr">ProjectToken<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr"><span class="op">!</span></span><span class="vr">ok </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"invalid claims"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	sourceId </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">c<span class="op">.</span></span><span class="vr">Param<span class="op">(</span></span><span class="st">"id"</span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">sourceId </span><span class="vr"><span class="op">=</span></span><span class="vr"><span class="op">=</span> </span><span class="st">""</span><span> </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"missing required param id"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	source<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">db<span class="op">.</span></span><span class="vr">Client<span class="op">.</span></span><span class="vr">Source<span class="op">.</span></span><span class="vr">Query<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">Where<span class="op">(</span></span><span class="vr">source<span class="op">.</span></span><span class="vr">And<span class="op">(</span></span><span class="vr">source<span class="op">.</span></span><span class="vr">SourceProject<span class="op">(</span></span><span class="vr">claims<span class="op">.</span></span><span class="vr">ProjectId<span class="op">)</span></span><span class="vr"><span class="op">,</span> </span><span class="vr">source<span class="op">.</span></span><span class="vr">ID<span class="op">(</span></span><span class="vr">sourceId<span class="op">)</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">Only<span class="op">(</span></span><span class="vr">context<span class="op">.</span></span><span class="vr">Background<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"could not fetch source"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	err </span><span class="vr"><span class="op">=</span> </span><span class="vr">db<span class="op">.</span></span><span class="vr">Client<span class="op">.</span></span><span class="vr">Source<span class="op">.</span></span><span class="vr">DeleteOne<span class="op">(</span></span><span class="vr">source<span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">Exec<span class="op">(</span></span><span class="vr">context<span class="op">.</span></span><span class="vr">Background<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"could not delete source"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">200<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"status"</span><span class="vr"><span class="op">:</span> </span><span class="st">"ok"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">type </span><span class="vr">CreateFacebookSourceParams </span><span class="kw">struct </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	AccountId </span><span> </span><span> </span><span class="tp">string </span><span class="vr">`json<span class="op">:</span></span><span class="st">"accountId"</span><span> </span><span class="vr">binding<span class="op">:</span></span><span class="st">"required"</span><span>`
</span><span class="vr">	AccessToken </span><span class="tp">string </span><span class="vr">`json<span class="op">:</span></span><span class="st">"accessToken"</span><span> </span><span class="vr">binding<span class="op">:</span></span><span class="st">"required"</span><span>`
</span><span class="vr">	SourceName </span><span> </span><span class="tp">string </span><span class="vr">`json<span class="op">:</span></span><span class="st">"sourceName"</span><span> </span><span class="vr">binding<span class="op">:</span></span><span class="st">"required"</span><span>`
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">type </span><span class="vr">FBTokenResponse </span><span class="kw">struct </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	Token </span><span class="tp">string </span><span class="vr">`json<span class="op">:</span></span><span class="st">"access_token"</span><span> </span><span class="vr">binding<span class="op">:</span></span><span class="st">"required"</span><span>`
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">func </span><span class="vr">CreateFacebookSource<span class="op">(</span></span><span class="vr">c </span><span class="vr"><span class="op">*</span></span><span class="vr">gin<span class="op">.</span></span><span class="vr">Context<span class="op">)</span> </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	claimsObj<span class="op">,</span> </span><span class="vr">ok </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">c<span class="op">.</span></span><span class="vr">Get<span class="op">(</span></span><span class="st">"project-claims"</span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr"><span class="op">!</span></span><span class="vr">ok </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"missing claims"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	claims<span class="op">,</span> </span><span class="vr">ok </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">claimsObj<span class="op">.</span></span><span class="vr"><span class="op">(</span></span><span class="vr"><span class="op">*</span></span><span class="vr">tokens<span class="op">.</span></span><span class="vr">ProjectToken<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr"><span class="op">!</span></span><span class="vr">ok </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"invalid claims"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="kw">	var </span><span class="vr">params </span><span class="vr">CreateFacebookSourceParams
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">c<span class="op">.</span></span><span class="vr">ShouldBindJSON<span class="op">(</span></span><span class="vr"><span class="op">&</span></span><span class="vr">params<span class="op">)</span></span><span class="vr"><span class="op">;</span> </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	urlStr </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">fmt<span class="op">.</span></span><span class="vr">Sprintf<span class="op">(</span></span><span class="vr">"https<span class="op">:</span><span class="op">/</span><span class="op">/</span>graph<span class="op">.</span>facebook<span class="op">.</span>com<span class="op">/</span>oauth<span class="op">/</span>access_token?grant_type<span class="op">=</span>fb_exchange_token<span class="op">&</span>client_id<span class="op">=</span><span class="op">%</span>v<span class="op">&</span>client_secret<span class="op">=</span><span class="op">%</span>v<span class="op">&</span>fb_exchange_token<span class="op">=</span><span class="op">%</span>v"</span><span class="vr"><span class="op">,</span> </span><span class="vr">os<span class="op">.</span></span><span class="vr">Getenv<span class="op">(</span></span><span class="st">"FB_APP_ID"</span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">,</span> </span><span class="vr">os<span class="op">.</span></span><span class="vr">Getenv<span class="op">(</span></span><span class="st">"FB_APP_SECRET"</span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">,</span> </span><span class="vr">params<span class="op">.</span></span><span class="vr">AccessToken<span class="op">)</span>
</span><span class="vr">	<span class="op">/</span></span><span class="vr"><span class="op">/</span> </span><span class="vr">fmt<span class="op">.</span></span><span class="vr">Println<span class="op">(</span></span><span class="vr">urlStr<span class="op">)</span>
</span><span class="vr">	reqUrl<span class="op">,</span> </span><span class="vr">_ </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">url<span class="op">.</span></span><span class="vr">Parse<span class="op">(</span></span><span class="vr">urlStr<span class="op">)</span>
</span><span class="vr">	req </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr"><span class="op">&</span></span><span class="vr">http<span class="op">.</span></span><span class="vr">Request<span class="op">{</span>
</span><span class="vr">		Method<span class="op">:</span> </span><span class="st">"GET"</span><span class="vr"><span class="op">,</span>
</span><span class="vr">		URL<span class="op">:</span> </span><span> </span><span> </span><span> </span><span class="vr">reqUrl<span class="op">,</span>
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	response<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">http<span class="op">.</span></span><span class="vr">DefaultClient<span class="op">.</span></span><span class="vr">Do<span class="op">(</span></span><span class="vr">req<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"could not trade token"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	responseData<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">ioutil<span class="op">.</span></span><span class="vr">ReadAll<span class="op">(</span></span><span class="vr">response<span class="op">.</span></span><span class="vr">Body<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"could not read FB response"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="kw">	if </span><span class="vr">response<span class="op">.</span></span><span class="vr">StatusCode </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="nm">200 </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="vr">fmt<span class="op">.</span></span><span class="vr">Sprintf<span class="op">(</span></span><span class="vr">"could not trade token<span class="op">,</span> invalid status code<span class="op">:</span> <span class="op">%</span>v response<span class="op">:</span> <span class="op">%</span>v"</span><span class="vr"><span class="op">,</span> </span><span class="vr">response<span class="op">.</span></span><span class="vr">StatusCode<span class="op">,</span> </span><span class="tp">string<span class="op">(</span></span><span class="vr">responseData<span class="op">)</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	<span class="op">/</span></span><span class="vr"><span class="op">/</span> </span><span class="vr">fmt<span class="op">.</span></span><span class="vr">Println<span class="op">(</span></span><span class="tp">string<span class="op">(</span></span><span class="vr">responseData<span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">	var </span><span class="vr">token </span><span class="vr">FBTokenResponse
</span><span class="vr">	err </span><span class="vr"><span class="op">=</span> </span><span class="vr">json<span class="op">.</span></span><span class="vr">Unmarshal<span class="op">(</span></span><span class="vr">responseData<span class="op">,</span> </span><span class="vr"><span class="op">&</span></span><span class="vr">token<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"could not parse FB response"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	sourceId<span class="op">,</span> </span><span class="vr">_ </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">nanoid<span class="op">.</span></span><span class="vr">Nanoid<span class="op">(</span></span><span class="vr">10<span class="op">)</span>
</span><span class="vr">	source<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">db<span class="op">.</span></span><span class="vr">Client<span class="op">.</span></span><span class="vr">Source<span class="op">.</span></span><span class="vr">Create<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">SetID<span class="op">(</span></span><span class="vr">sourceId<span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">SetType<span class="op">(</span></span><span class="st">"fb"</span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">SetProjectID<span class="op">(</span></span><span class="vr">claims<span class="op">.</span></span><span class="vr">ProjectId<span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">SetConfig<span class="op">(</span></span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>		</span><span class="st">"accountId"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span class="vr">params<span class="op">.</span></span><span class="vr">AccountId<span class="op">,</span>
</span><span>		</span><span class="st">"accessToken"</span><span class="vr"><span class="op">:</span> </span><span class="vr">token<span class="op">.</span></span><span class="vr">Token<span class="op">,</span>
</span><span class="vr">	<span class="op">}</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">SetName<span class="op">(</span></span><span class="vr">params<span class="op">.</span></span><span class="vr">SourceName<span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">Save<span class="op">(</span></span><span class="vr">context<span class="op">.</span></span><span class="vr">Background<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"could not create source"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">200<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"status"</span><span class="vr"><span class="op">:</span> </span><span class="st">"ok"</span><span class="vr"><span class="op">,</span> </span><span class="st">"source"</span><span class="vr"><span class="op">:</span> </span><span class="vr">source<span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">type </span><span class="vr">CreateGoogleSourceParams </span><span class="kw">struct </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	State </span><span class="tp">string </span><span class="vr">`json<span class="op">:</span></span><span class="st">"state"</span><span> </span><span class="vr">binding<span class="op">:</span></span><span class="st">"required"</span><span>`
</span><span class="vr">	Code </span><span> </span><span class="tp">string </span><span class="vr">`json<span class="op">:</span></span><span class="st">"code"</span><span> </span><span class="vr">binding<span class="op">:</span></span><span class="st">"required"</span><span>`
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">type </span><span class="vr">GoogleResponse </span><span class="kw">struct </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	RefreshToken </span><span class="tp">string </span><span class="vr">`json<span class="op">:</span></span><span class="st">"refresh_token"</span><span> </span><span class="vr">binding<span class="op">:</span></span><span class="st">"required"</span><span>`
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">func </span><span class="vr">CreateGoogleSource<span class="op">(</span></span><span class="vr">c </span><span class="vr"><span class="op">*</span></span><span class="vr">gin<span class="op">.</span></span><span class="vr">Context<span class="op">)</span> </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	claimsObj<span class="op">,</span> </span><span class="vr">ok </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">c<span class="op">.</span></span><span class="vr">Get<span class="op">(</span></span><span class="st">"project-claims"</span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr"><span class="op">!</span></span><span class="vr">ok </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"missing claims"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	claims<span class="op">,</span> </span><span class="vr">ok </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">claimsObj<span class="op">.</span></span><span class="vr"><span class="op">(</span></span><span class="vr"><span class="op">*</span></span><span class="vr">tokens<span class="op">.</span></span><span class="vr">ProjectToken<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr"><span class="op">!</span></span><span class="vr">ok </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"invalid claims"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="kw">	var </span><span class="vr">params </span><span class="vr">CreateGoogleSourceParams
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">c<span class="op">.</span></span><span class="vr">ShouldBindJSON<span class="op">(</span></span><span class="vr"><span class="op">&</span></span><span class="vr">params<span class="op">)</span></span><span class="vr"><span class="op">;</span> </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	urlStr </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">fmt<span class="op">.</span></span><span class="vr">Sprintf<span class="op">(</span>
</span><span>		</span><span class="vr">"https<span class="op">:</span><span class="op">/</span><span class="op">/</span>oauth2<span class="op">.</span>googleapis<span class="op">.</span>com<span class="op">/</span>token?code<span class="op">=</span><span class="op">%</span>v<span class="op">&</span>client_id<span class="op">=</span><span class="op">%</span>v<span class="op">&</span>client_secret<span class="op">=</span><span class="op">%</span>v<span class="op">&</span>grant_type<span class="op">=</span>authorization_code<span class="op">&</span>redirect_uri<span class="op">=</span><span class="op">%</span>v"</span><span class="vr"><span class="op">,</span>
</span><span class="vr">		params<span class="op">.</span></span><span class="vr">Code<span class="op">,</span>
</span><span class="vr">		os<span class="op">.</span></span><span class="vr">Getenv<span class="op">(</span></span><span class="st">"GA_CLIENT_ID"</span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">		os<span class="op">.</span></span><span class="vr">Getenv<span class="op">(</span></span><span class="st">"GA_SECRET"</span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">		os<span class="op">.</span></span><span class="vr">Getenv<span class="op">(</span></span><span class="st">"GA_REDIRECT_URI"</span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">	<span class="op">)</span>
</span><span class="vr">	reqUrl<span class="op">,</span> </span><span class="vr">_ </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">url<span class="op">.</span></span><span class="vr">Parse<span class="op">(</span></span><span class="vr">urlStr<span class="op">)</span>
</span><span class="vr">	req </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr"><span class="op">&</span></span><span class="vr">http<span class="op">.</span></span><span class="vr">Request<span class="op">{</span>
</span><span class="vr">		Method<span class="op">:</span> </span><span class="st">"POST"</span><span class="vr"><span class="op">,</span>
</span><span class="vr">		URL<span class="op">:</span> </span><span> </span><span> </span><span> </span><span class="vr">reqUrl<span class="op">,</span>
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	response<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">http<span class="op">.</span></span><span class="vr">DefaultClient<span class="op">.</span></span><span class="vr">Do<span class="op">(</span></span><span class="vr">req<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"could not trade code"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	responseData<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">ioutil<span class="op">.</span></span><span class="vr">ReadAll<span class="op">(</span></span><span class="vr">response<span class="op">.</span></span><span class="vr">Body<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"could not read GOOGLE response"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="kw">	if </span><span class="vr">response<span class="op">.</span></span><span class="vr">StatusCode </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="nm">200 </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="vr">fmt<span class="op">.</span></span><span class="vr">Sprintf<span class="op">(</span></span><span class="vr">"could not trade code<span class="op">,</span> invalid status code<span class="op">:</span> <span class="op">%</span>v response<span class="op">:</span> <span class="op">%</span>v"</span><span class="vr"><span class="op">,</span> </span><span class="vr">response<span class="op">.</span></span><span class="vr">StatusCode<span class="op">,</span> </span><span class="tp">string<span class="op">(</span></span><span class="vr">responseData<span class="op">)</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="kw">	var </span><span class="vr">token </span><span class="vr">GoogleResponse
</span><span class="vr">	err </span><span class="vr"><span class="op">=</span> </span><span class="vr">json<span class="op">.</span></span><span class="vr">Unmarshal<span class="op">(</span></span><span class="vr">responseData<span class="op">,</span> </span><span class="vr"><span class="op">&</span></span><span class="vr">token<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"could not parse google response"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	state<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">db<span class="op">.</span></span><span class="vr">Client<span class="op">.</span></span><span class="vr">GoogleOauthState<span class="op">.</span></span><span class="vr">Query<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">Where<span class="op">(</span></span><span class="vr">googleoauthstate<span class="op">.</span></span><span class="vr">ID<span class="op">(</span></span><span class="vr">params<span class="op">.</span></span><span class="vr">State<span class="op">)</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">Only<span class="op">(</span></span><span class="vr">context<span class="op">.</span></span><span class="vr">Background<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"could not fetch state"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	_ </span><span class="vr"><span class="op">=</span> </span><span class="vr">db<span class="op">.</span></span><span class="vr">Client<span class="op">.</span></span><span class="vr">GoogleOauthState<span class="op">.</span></span><span class="vr">DeleteOne<span class="op">(</span></span><span class="vr">state<span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">Exec<span class="op">(</span></span><span class="vr">context<span class="op">.</span></span><span class="vr">Background<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr">	sourceId<span class="op">,</span> </span><span class="vr">_ </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">nanoid<span class="op">.</span></span><span class="vr">Nanoid<span class="op">(</span></span><span class="vr">10<span class="op">)</span>
</span><span class="vr">	config </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>		</span><span class="st">"refresh_token"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="vr">token<span class="op">.</span></span><span class="vr">RefreshToken<span class="op">,</span>
</span><span>		</span><span class="st">"customer_id"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="vr">state<span class="op">.</span></span><span class="vr">CustomerID<span class="op">,</span>
</span><span>		</span><span class="st">"manager_customer_id"</span><span class="vr"><span class="op">:</span> </span><span class="vr">state<span class="op">.</span></span><span class="vr">ManagerID<span class="op">,</span>
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	source<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">db<span class="op">.</span></span><span class="vr">Client<span class="op">.</span></span><span class="vr">Source<span class="op">.</span></span><span class="vr">Create<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		SetID<span class="op">(</span></span><span class="vr">sourceId<span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		SetType<span class="op">(</span></span><span class="st">"ga"</span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		SetProjectID<span class="op">(</span></span><span class="vr">claims<span class="op">.</span></span><span class="vr">ProjectId<span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		SetConfig<span class="op">(</span></span><span class="vr">config<span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		SetName<span class="op">(</span></span><span class="vr">state<span class="op">.</span></span><span class="vr">SourceName<span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		Save<span class="op">(</span></span><span class="vr">context<span class="op">.</span></span><span class="vr">Background<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"could not create source"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">200<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"status"</span><span class="vr"><span class="op">:</span> </span><span class="st">"ok"</span><span class="vr"><span class="op">,</span> </span><span class="st">"source"</span><span class="vr"><span class="op">:</span> </span><span class="vr">source<span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">type </span><span class="vr">CreateCPSourceParams </span><span class="kw">struct </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	SourceName </span><span class="tp">string </span><span class="vr">`json<span class="op">:</span></span><span class="st">"source_name"</span><span> </span><span class="vr">binding<span class="op">:</span></span><span class="st">"required"</span><span>`
</span><span class="vr">	Numbers </span><span> </span><span> </span><span> </span><span class="vr"><span class="op">[</span></span><span class="vr"><span class="op">]</span></span><span class="kw">struct </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		Name </span><span> </span><span> </span><span class="tp">string </span><span class="vr">`json<span class="op">:</span></span><span class="st">"name"</span><span> </span><span class="vr">binding<span class="op">:</span></span><span class="st">"required"</span><span>`
</span><span class="vr">		Number </span><span class="tp">string </span><span class="vr">`json<span class="op">:</span></span><span class="st">"number"</span><span> </span><span class="vr">binding<span class="op">:</span></span><span class="st">"required"</span><span>`
</span><span class="vr">	<span class="op">}</span> </span><span class="vr">`json<span class="op">:</span></span><span class="st">"numbers"</span><span> </span><span class="vr">binding<span class="op">:</span></span><span class="st">"required"</span><span>`
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">func </span><span class="vr">CreateCPSource<span class="op">(</span></span><span class="vr">c </span><span class="vr"><span class="op">*</span></span><span class="vr">gin<span class="op">.</span></span><span class="vr">Context<span class="op">)</span> </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	claimsObj<span class="op">,</span> </span><span class="vr">ok </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">c<span class="op">.</span></span><span class="vr">Get<span class="op">(</span></span><span class="st">"project-claims"</span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr"><span class="op">!</span></span><span class="vr">ok </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"missing claims"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	claims<span class="op">,</span> </span><span class="vr">ok </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">claimsObj<span class="op">.</span></span><span class="vr"><span class="op">(</span></span><span class="vr"><span class="op">*</span></span><span class="vr">tokens<span class="op">.</span></span><span class="vr">ProjectToken<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr"><span class="op">!</span></span><span class="vr">ok </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"invalid claims"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="kw">	var </span><span class="vr">params </span><span class="vr">CreateCPSourceParams
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">c<span class="op">.</span></span><span class="vr">ShouldBindJSON<span class="op">(</span></span><span class="vr"><span class="op">&</span></span><span class="vr">params<span class="op">)</span></span><span class="vr"><span class="op">;</span> </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	sourceId<span class="op">,</span> </span><span class="vr">_ </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">nanoid<span class="op">.</span></span><span class="vr">Nanoid<span class="op">(</span></span><span class="vr">10<span class="op">)</span>
</span><span class="vr">	source<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">db<span class="op">.</span></span><span class="vr">Client<span class="op">.</span></span><span class="vr">Source<span class="op">.</span></span><span class="vr">Create<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		SetName<span class="op">(</span></span><span class="vr">params<span class="op">.</span></span><span class="vr">SourceName<span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		SetID<span class="op">(</span></span><span class="vr">sourceId<span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		SetType<span class="op">(</span></span><span class="st">"cp"</span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		SetProjectID<span class="op">(</span></span><span class="vr">claims<span class="op">.</span></span><span class="vr">ProjectId<span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		SetConfig<span class="op">(</span></span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>			</span><span class="st">"numbers"</span><span class="vr"><span class="op">:</span> </span><span class="vr">params<span class="op">.</span></span><span class="vr">Numbers<span class="op">,</span>
</span><span class="vr">		<span class="op">}</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">Save<span class="op">(</span></span><span class="vr">context<span class="op">.</span></span><span class="vr">Background<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"could not create source"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">200<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"status"</span><span class="vr"><span class="op">:</span> </span><span class="st">"ok"</span><span class="vr"><span class="op">,</span> </span><span class="st">"source"</span><span class="vr"><span class="op">:</span> </span><span class="vr">source<span class="op">,</span> </span><span class="st">"url"</span><span class="vr"><span class="op">:</span> </span><span class="vr">"https<span class="op">:</span><span class="op">/</span><span class="op">/</span>dash<span class="op">.</span>gbs<span class="op">-</span>digital<span class="op">.</span>com<span class="op">/</span>t<span class="op">/</span>cp"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">func </span><span class="vr">notifyCpHook<span class="op">(</span></span><span class="vr">body </span><span class="vr">db<span class="op">.</span></span><span class="vr">CallPickerRecord<span class="op">)</span> </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	data<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">json<span class="op">.</span></span><span class="vr">Marshal<span class="op">(</span></span><span class="vr">body<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		fmt<span class="op">.</span></span><span class="vr">Printf<span class="op">(</span></span><span class="vr">"Could not post to CP hook<span class="op">:</span> <span class="op">%</span>v\n"</span><span class="vr"><span class="op">,</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	_<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">=</span> </span><span class="vr">http<span class="op">.</span></span><span class="vr">Post<span class="op">(</span></span><span class="vr">"https<span class="op">:</span><span class="op">/</span><span class="op">/</span>hooks<span class="op">.</span>zapier<span class="op">.</span>com<span class="op">/</span>hooks<span class="op">/</span>catch<span class="op">/</span>6820014<span class="op">/</span>bz8ghqa"</span><span class="vr"><span class="op">,</span> </span><span class="st">"application/json"</span><span class="vr"><span class="op">,</span> </span><span class="vr">bytes<span class="op">.</span></span><span class="vr">NewBuffer<span class="op">(</span></span><span class="vr">data<span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		fmt<span class="op">.</span></span><span class="vr">Printf<span class="op">(</span></span><span class="vr">"Could not post to CP hook<span class="op">:</span> <span class="op">%</span>v\n"</span><span class="vr"><span class="op">,</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">func </span><span class="vr">CPTransport<span class="op">(</span></span><span class="vr">c </span><span class="vr"><span class="op">*</span></span><span class="vr">gin<span class="op">.</span></span><span class="vr">Context<span class="op">)</span> </span><span class="vr"><span class="op">{</span>
</span><span class="kw">	var </span><span class="vr">body </span><span class="vr">db<span class="op">.</span></span><span class="vr">CallPickerRecord
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">c<span class="op">.</span></span><span class="vr">ShouldBindJSON<span class="op">(</span></span><span class="vr"><span class="op">&</span></span><span class="vr">body<span class="op">)</span></span><span class="vr"><span class="op">;</span> </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	fmt<span class="op">.</span></span><span class="vr">Println<span class="op">(</span></span><span class="vr">body<span class="op">)</span>
</span><span class="kw">	go </span><span class="vr">notifyCpHook<span class="op">(</span></span><span class="vr">body<span class="op">)</span>
</span><span class="vr">	projectId<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">db<span class="op">.</span></span><span class="vr">Transport<span class="op">.</span></span><span class="vr">GetCPSourceProject<span class="op">(</span></span><span class="vr">body<span class="op">.</span></span><span class="vr">CpNumber<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="vr">"The project does not exist<span class="op">,</span> is inactive or is not connected to Call Picker"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr">		fmt<span class="op">.</span></span><span class="vr">Printf<span class="op">(</span></span><span class="vr">"Error<span class="op">:</span> source not found<span class="op">:</span> <span class="op">%</span>v\n"</span><span class="vr"><span class="op">,</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	err </span><span class="vr"><span class="op">=</span> </span><span class="vr">db<span class="op">.</span></span><span class="vr">Transport<span class="op">.</span></span><span class="vr">InsertCpRecord<span class="op">(</span></span><span class="vr">projectId<span class="op">,</span> </span><span class="vr">body<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"could not insert record"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr">		fmt<span class="op">.</span></span><span class="vr">Printf<span class="op">(</span></span><span class="vr">"Error<span class="op">:</span> could not insert record<span class="op">:</span> <span class="op">%</span>v\n"</span><span class="vr"><span class="op">,</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">200<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"status"</span><span class="vr"><span class="op">:</span> </span><span class="st">"ok"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">func </span><span class="vr">parseFbSource<span class="op">(</span></span><span class="vr">v </span><span class="vr"><span class="op">*</span></span><span class="vr">ent<span class="op">.</span></span><span class="vr">Source<span class="op">,</span> </span><span class="vr">sourcesObj </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">)</span> </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	sourcesObj<span class="op">[</span></span><span class="vr">fmt<span class="op">.</span></span><span class="vr">Sprintf<span class="op">(</span></span><span class="st">"%v_%v_%v"</span><span class="vr"><span class="op">,</span> </span><span class="vr">v<span class="op">.</span></span><span class="vr">Name<span class="op">,</span> </span><span class="vr">v<span class="op">.</span></span><span class="vr">Type<span class="op">,</span> </span><span class="vr">v<span class="op">.</span></span><span class="vr">SourceProject<span class="op">)</span></span><span class="vr"><span class="op">]</span> </span><span class="vr"><span class="op">=</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>		</span><span class="st">"type"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"facebook_marketing"</span><span class="vr"><span class="op">,</span>
</span><span>		</span><span class="st">"destinations"</span><span class="vr"><span class="op">:</span> </span><span class="vr"><span class="op">[</span></span><span class="vr"><span class="op">]</span></span><span class="tp">string<span class="op">{</span></span><span class="vr">fmt<span class="op">.</span></span><span class="vr">Sprintf<span class="op">(</span></span><span class="st">"postgres_%v"</span><span class="vr"><span class="op">,</span> </span><span class="vr">v<span class="op">.</span></span><span class="vr">SourceProject<span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span>		</span><span class="st">"config"</span><span class="vr"><span class="op">:</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>			</span><span class="st">"account_id"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span class="vr">v<span class="op">.</span></span><span class="vr">Config<span class="op">[</span></span><span class="st">"accountId"</span><span class="vr"><span class="op">]</span></span><span class="vr"><span class="op">,</span>
</span><span>			</span><span class="st">"access_token"</span><span class="vr"><span class="op">:</span> </span><span class="vr">v<span class="op">.</span></span><span class="vr">Config<span class="op">[</span></span><span class="st">"accessToken"</span><span class="vr"><span class="op">]</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">		<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span>		</span><span class="st">"collections"</span><span class="vr"><span class="op">:</span> </span><span class="vr"><span class="op">[</span></span><span class="vr"><span class="op">]</span></span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span class="vr">			<span class="op">{</span>
</span><span>				</span><span class="st">"name"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"ads"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"type"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"ads"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"level"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span class="st">"ad"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"schedule"</span><span class="vr"><span class="op">:</span> </span><span class="st">"*/20 * * * *"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"parameters"</span><span class="vr"><span class="op">:</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>					</span><span class="st">"fields"</span><span class="vr"><span class="op">:</span> </span><span class="vr"><span class="op">[</span></span><span class="vr"><span class="op">]</span></span><span class="tp">string<span class="op">{</span></span><span class="st">"bid_amount"</span><span class="vr"><span class="op">,</span> </span><span class="st">"adlabels"</span><span class="vr"><span class="op">,</span> </span><span class="st">"creative"</span><span class="vr"><span class="op">,</span> </span><span class="st">"status"</span><span class="vr"><span class="op">,</span> </span><span class="st">"created_time"</span><span class="vr"><span class="op">,</span> </span><span class="st">"updated_time"</span><span class="vr"><span class="op">,</span> </span><span class="st">"targeting"</span><span class="vr"><span class="op">,</span> </span><span class="st">"effective_status"</span><span class="vr"><span class="op">,</span> </span><span class="st">"campaign_id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"adset_id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"conversion_specs"</span><span class="vr"><span class="op">,</span> </span><span class="st">"recommendations"</span><span class="vr"><span class="op">,</span> </span><span class="st">"id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"bid_info"</span><span class="vr"><span class="op">,</span> </span><span class="st">"tracking_specs"</span><span class="vr"><span class="op">,</span> </span><span class="st">"bid_type"</span><span class="vr"><span class="op">,</span> </span><span class="st">"name"</span><span class="vr"><span class="op">,</span> </span><span class="st">"account_id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"source_ad_id"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">				<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">			<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">			<span class="op">{</span>
</span><span>				</span><span class="st">"name"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"adset"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"type"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"ads"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"level"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span class="st">"adset"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"schedule"</span><span class="vr"><span class="op">:</span> </span><span class="st">"*/20 * * * *"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"parameters"</span><span class="vr"><span class="op">:</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>					</span><span class="st">"fields"</span><span class="vr"><span class="op">:</span> </span><span class="vr"><span class="op">[</span></span><span class="vr"><span class="op">]</span></span><span class="tp">string<span class="op">{</span></span><span class="st">"bid_amount"</span><span class="vr"><span class="op">,</span> </span><span class="st">"adlabels"</span><span class="vr"><span class="op">,</span> </span><span class="st">"creative"</span><span class="vr"><span class="op">,</span> </span><span class="st">"status"</span><span class="vr"><span class="op">,</span> </span><span class="st">"created_time"</span><span class="vr"><span class="op">,</span> </span><span class="st">"updated_time"</span><span class="vr"><span class="op">,</span> </span><span class="st">"targeting"</span><span class="vr"><span class="op">,</span> </span><span class="st">"effective_status"</span><span class="vr"><span class="op">,</span> </span><span class="st">"campaign_id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"adset_id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"conversion_specs"</span><span class="vr"><span class="op">,</span> </span><span class="st">"recommendations"</span><span class="vr"><span class="op">,</span> </span><span class="st">"id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"bid_info"</span><span class="vr"><span class="op">,</span> </span><span class="st">"tracking_specs"</span><span class="vr"><span class="op">,</span> </span><span class="st">"bid_type"</span><span class="vr"><span class="op">,</span> </span><span class="st">"name"</span><span class="vr"><span class="op">,</span> </span><span class="st">"account_id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"source_ad_id"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">				<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">			<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">			<span class="op">{</span>
</span><span>				</span><span class="st">"name"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"campaign"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"type"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"ads"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"level"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span class="st">"campaign"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"schedule"</span><span class="vr"><span class="op">:</span> </span><span class="st">"*/30 * * * *"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"parameters"</span><span class="vr"><span class="op">:</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>					</span><span class="st">"fields"</span><span class="vr"><span class="op">:</span> </span><span class="vr"><span class="op">[</span></span><span class="vr"><span class="op">]</span></span><span class="tp">string<span class="op">{</span></span><span class="st">"bid_amount"</span><span class="vr"><span class="op">,</span> </span><span class="st">"adlabels"</span><span class="vr"><span class="op">,</span> </span><span class="st">"creative"</span><span class="vr"><span class="op">,</span> </span><span class="st">"status"</span><span class="vr"><span class="op">,</span> </span><span class="st">"created_time"</span><span class="vr"><span class="op">,</span> </span><span class="st">"updated_time"</span><span class="vr"><span class="op">,</span> </span><span class="st">"targeting"</span><span class="vr"><span class="op">,</span> </span><span class="st">"effective_status"</span><span class="vr"><span class="op">,</span> </span><span class="st">"campaign_id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"adset_id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"conversion_specs"</span><span class="vr"><span class="op">,</span> </span><span class="st">"recommendations"</span><span class="vr"><span class="op">,</span> </span><span class="st">"id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"bid_info"</span><span class="vr"><span class="op">,</span> </span><span class="st">"tracking_specs"</span><span class="vr"><span class="op">,</span> </span><span class="st">"bid_type"</span><span class="vr"><span class="op">,</span> </span><span class="st">"name"</span><span class="vr"><span class="op">,</span> </span><span class="st">"account_id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"source_ad_id"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">				<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">			<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">			<span class="op">{</span>
</span><span>				</span><span class="st">"name"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"account"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"type"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"account"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"level"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span class="st">"account"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"schedule"</span><span class="vr"><span class="op">:</span> </span><span class="st">"*/60 * * * *"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"parameters"</span><span class="vr"><span class="op">:</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>					</span><span class="st">"fields"</span><span class="vr"><span class="op">:</span> </span><span class="vr"><span class="op">[</span></span><span class="vr"><span class="op">]</span></span><span class="tp">string<span class="op">{</span></span><span class="st">"bid_amount"</span><span class="vr"><span class="op">,</span> </span><span class="st">"adlabels"</span><span class="vr"><span class="op">,</span> </span><span class="st">"creative"</span><span class="vr"><span class="op">,</span> </span><span class="st">"status"</span><span class="vr"><span class="op">,</span> </span><span class="st">"created_time"</span><span class="vr"><span class="op">,</span> </span><span class="st">"updated_time"</span><span class="vr"><span class="op">,</span> </span><span class="st">"targeting"</span><span class="vr"><span class="op">,</span> </span><span class="st">"effective_status"</span><span class="vr"><span class="op">,</span> </span><span class="st">"campaign_id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"adset_id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"conversion_specs"</span><span class="vr"><span class="op">,</span> </span><span class="st">"recommendations"</span><span class="vr"><span class="op">,</span> </span><span class="st">"id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"bid_info"</span><span class="vr"><span class="op">,</span> </span><span class="st">"tracking_specs"</span><span class="vr"><span class="op">,</span> </span><span class="st">"bid_type"</span><span class="vr"><span class="op">,</span> </span><span class="st">"name"</span><span class="vr"><span class="op">,</span> </span><span class="st">"account_id"</span><span class="vr"><span class="op">,</span> </span><span class="st">"source_ad_id"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">				<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">			<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">		<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">func </span><span class="vr">parseGaSource<span class="op">(</span></span><span class="vr">v </span><span class="vr"><span class="op">*</span></span><span class="vr">ent<span class="op">.</span></span><span class="vr">Source<span class="op">,</span> </span><span class="vr">obj </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">)</span> </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	obj<span class="op">[</span></span><span class="vr">fmt<span class="op">.</span></span><span class="vr">Sprintf<span class="op">(</span></span><span class="st">"%v_%v_%v"</span><span class="vr"><span class="op">,</span> </span><span class="vr">v<span class="op">.</span></span><span class="vr">Name<span class="op">,</span> </span><span class="vr">v<span class="op">.</span></span><span class="vr">Type<span class="op">,</span> </span><span class="vr">v<span class="op">.</span></span><span class="vr">SourceProject<span class="op">)</span></span><span class="vr"><span class="op">]</span> </span><span class="vr"><span class="op">=</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>		</span><span class="st">"type"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"google_ads"</span><span class="vr"><span class="op">,</span>
</span><span>		</span><span class="st">"destinations"</span><span class="vr"><span class="op">:</span> </span><span class="vr"><span class="op">[</span></span><span class="vr"><span class="op">]</span></span><span class="tp">string<span class="op">{</span></span><span class="vr">fmt<span class="op">.</span></span><span class="vr">Sprintf<span class="op">(</span></span><span class="st">"postgres_%v"</span><span class="vr"><span class="op">,</span> </span><span class="vr">v<span class="op">.</span></span><span class="vr">SourceProject<span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span>		</span><span class="st">"config"</span><span class="vr"><span class="op">:</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>			</span><span class="st">"customer_id"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="vr">v<span class="op">.</span></span><span class="vr">Config<span class="op">[</span></span><span class="st">"customer_id"</span><span class="vr"><span class="op">]</span></span><span class="vr"><span class="op">,</span>
</span><span>			</span><span class="st">"manager_customer_id"</span><span class="vr"><span class="op">:</span> </span><span class="vr">v<span class="op">.</span></span><span class="vr">Config<span class="op">[</span></span><span class="st">"manager_customer_id"</span><span class="vr"><span class="op">]</span></span><span class="vr"><span class="op">,</span>
</span><span>			</span><span class="st">"auth"</span><span class="vr"><span class="op">:</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>				</span><span class="st">"type"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"OAuth"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"client_id"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span class="vr">os<span class="op">.</span></span><span class="vr">Getenv<span class="op">(</span></span><span class="st">"GA_CLIENT_ID"</span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"client_secret"</span><span class="vr"><span class="op">:</span> </span><span class="vr">os<span class="op">.</span></span><span class="vr">Getenv<span class="op">(</span></span><span class="st">"GA_SECRET"</span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"refresh_token"</span><span class="vr"><span class="op">:</span> </span><span class="vr">v<span class="op">.</span></span><span class="vr">Config<span class="op">[</span></span><span class="st">"refresh_token"</span><span class="vr"><span class="op">]</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">			<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">		<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span>		</span><span class="st">"schedule"</span><span class="vr"><span class="op">:</span> </span><span class="st">"*/60 * * * *"</span><span class="vr"><span class="op">,</span>
</span><span>		</span><span class="st">"collections"</span><span class="vr"><span class="op">:</span> </span><span class="vr"><span class="op">[</span></span><span class="vr"><span class="op">]</span></span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span class="vr">			<span class="op">{</span>
</span><span>				</span><span class="st">"name"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"accessible_bidding_strategy"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"type"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"accessible_bidding_strategy"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"table_name"</span><span class="vr"><span class="op">:</span> </span><span class="st">"gads_accessible_bidding_strategy"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"schedule"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span class="st">"*/60 * * * *"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"parameters"</span><span class="vr"><span class="op">:</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>					</span><span class="st">"fields"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span class="kw">"accessible_bidding_strategy<span class="op">.</span>id<span class="op">,</span> accessible_bidding_strategy<span class="op">.</span>maximize_conversion_value<span class="op">.</span>target_roas<span class="op">,</span> accessible_bidding_strategy<span class="op">.</span>maximize_conversions<span class="op">.</span>target_cpa<span class="op">,</span> accessible_bidding_strategy<span class="op">.</span>name<span class="op">,</span> accessible_bidding_strategy<span class="op">.</span>owner_customer_id<span class="op">,</span> accessible_bidding_strategy<span class="op">.</span>owner_descriptive_name<span class="op">,</span> accessible_bidding_strategy<span class="op">.</span>resource_name<span class="op">,</span> accessible_bidding_strategy<span class="op">.</span>target_cpa<span class="op">.</span>target_cpa_micros<span class="op">,</span> accessible_bidding_strategy<span class="op">.</span>target_impression_share<span class="op">.</span>cpc_bid_ceiling_micros<span class="op">,</span> accessible_bidding_strategy<span class="op">.</span>target_impression_share<span class="op">.</span>location<span class="op">,</span> accessible_bidding_strategy<span class="op">.</span>target_impression_share<span class="op">.</span>location_fraction_micros<span class="op">,</span> accessible_bidding_strategy<span class="op">.</span>target_roas<span class="op">.</span>target_roas<span class="op">,</span> accessible_bidding_strategy<span class="op">.</span>target_spend<span class="op">.</span>cpc_bid_ceiling_micros<span class="op">,</span> accessible_bidding_strategy<span class="op">.</span>target_spend<span class="op">.</span>target_spend_micros<span class="op">,</span> accessible_bidding_strategy<span class="op">.</span>type"</span><span class="vr"><span class="op">,</span>
</span><span>					</span><span class="st">"start_date"</span><span class="vr"><span class="op">:</span> </span><span class="st">"2021-01-01"</span><span class="vr"><span class="op">,</span>
</span><span class="vr">				<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">			<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">			<span class="op">{</span>
</span><span>				</span><span class="st">"name"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"account_budget"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"type"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"account_budget"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"table_name"</span><span class="vr"><span class="op">:</span> </span><span class="st">"gads_account_budget"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"schedule"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span class="st">"*/60 * * * *"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"parameters"</span><span class="vr"><span class="op">:</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>					</span><span class="st">"fields"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span class="vr">"account_budget<span class="op">.</span>adjusted_spending_limit_micros<span class="op">,</span> account_budget<span class="op">.</span>adjusted_spending_limit_type<span class="op">,</span> account_budget<span class="op">.</span>amount_served_micros<span class="op">,</span> account_budget<span class="op">.</span>approved_end_date_time<span class="op">,</span> account_budget<span class="op">.</span>approved_end_time_type<span class="op">,</span> account_budget<span class="op">.</span>approved_spending_limit_micros<span class="op">,</span> account_budget<span class="op">.</span>approved_spending_limit_type<span class="op">,</span> account_budget<span class="op">.</span>approved_start_date_time<span class="op">,</span> account_budget<span class="op">.</span>billing_setup<span class="op">,</span> account_budget<span class="op">.</span>id<span class="op">,</span> account_budget<span class="op">.</span>name<span class="op">,</span> account_budget<span class="op">.</span>notes<span class="op">,</span> account_budget<span class="op">.</span>pending_proposal<span class="op">.</span>account_budget_proposal<span class="op">,</span> account_budget<span class="op">.</span>pending_proposal<span class="op">.</span>creation_date_time<span class="op">,</span> account_budget<span class="op">.</span>pending_proposal<span class="op">.</span>end_date_time<span class="op">,</span> account_budget<span class="op">.</span>pending_proposal<span class="op">.</span>end_time_type<span class="op">,</span> account_budget<span class="op">.</span>pending_proposal<span class="op">.</span>name<span class="op">,</span> account_budget<span class="op">.</span>pending_proposal<span class="op">.</span>notes<span class="op">,</span> account_budget<span class="op">.</span>pending_proposal<span class="op">.</span>proposal_type<span class="op">,</span> account_budget<span class="op">.</span>pending_proposal<span class="op">.</span>purchase_order_number<span class="op">,</span> account_budget<span class="op">.</span>pending_proposal<span class="op">.</span>spending_limit_micros<span class="op">,</span> account_budget<span class="op">.</span>pending_proposal<span class="op">.</span>spending_limit_type<span class="op">,</span> account_budget<span class="op">.</span>pending_proposal<span class="op">.</span>start_date_time<span class="op">,</span> account_budget<span class="op">.</span>proposed_end_date_time<span class="op">,</span> account_budget<span class="op">.</span>proposed_end_time_type<span class="op">,</span> account_budget<span class="op">.</span>proposed_spending_limit_micros<span class="op">,</span> account_budget<span class="op">.</span>proposed_spending_limit_type<span class="op">,</span> account_budget<span class="op">.</span>proposed_start_date_time<span class="op">,</span> account_budget<span class="op">.</span>purchase_order_number<span class="op">,</span> account_budget<span class="op">.</span>resource_name<span class="op">,</span> account_budget<span class="op">.</span>status<span class="op">,</span> account_budget<span class="op">.</span>total_adjustments_micros"</span><span class="vr"><span class="op">,</span>
</span><span>					</span><span class="st">"start_date"</span><span class="vr"><span class="op">:</span> </span><span class="st">"2021-01-01"</span><span class="vr"><span class="op">,</span>
</span><span class="vr">				<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">			<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">			<span class="op">{</span>
</span><span>				</span><span class="st">"name"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"account_budget_proposal"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"type"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="st">"account_budget_proposal"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"table_name"</span><span class="vr"><span class="op">:</span> </span><span class="st">"gads_account_budget_proposal"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"schedule"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span class="st">"*/60 * * * *"</span><span class="vr"><span class="op">,</span>
</span><span>				</span><span class="st">"parameters"</span><span class="vr"><span class="op">:</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span>
</span><span>					</span><span class="st">"fields"</span><span class="vr"><span class="op">:</span> </span><span> </span><span> </span><span> </span><span> </span><span class="vr">"account_budget_proposal<span class="op">.</span>account_budget<span class="op">,</span> account_budget_proposal<span class="op">.</span>approval_date_time<span class="op">,</span> account_budget_proposal<span class="op">.</span>approved_end_date_time<span class="op">,</span> account_budget_proposal<span class="op">.</span>approved_end_time_type<span class="op">,</span> account_budget_proposal<span class="op">.</span>approved_spending_limit_micros<span class="op">,</span> account_budget_proposal<span class="op">.</span>approved_spending_limit_type<span class="op">,</span> account_budget_proposal<span class="op">.</span>approved_start_date_time<span class="op">,</span> account_budget_proposal<span class="op">.</span>billing_setup<span class="op">,</span> account_budget_proposal<span class="op">.</span>creation_date_time<span class="op">,</span> account_budget_proposal<span class="op">.</span>id<span class="op">,</span> account_budget_proposal<span class="op">.</span>proposal_type<span class="op">,</span> account_budget_proposal<span class="op">.</span>proposed_end_date_time<span class="op">,</span> account_budget_proposal<span class="op">.</span>proposed_end_time_type<span class="op">,</span> account_budget_proposal<span class="op">.</span>proposed_name<span class="op">,</span> account_budget_proposal<span class="op">.</span>proposed_notes<span class="op">,</span> account_budget_proposal<span class="op">.</span>proposed_purchase_order_number<span class="op">,</span> account_budget_proposal<span class="op">.</span>proposed_spending_limit_micros<span class="op">,</span> account_budget_proposal<span class="op">.</span>proposed_spending_limit_type<span class="op">,</span> account_budget_proposal<span class="op">.</span>proposed_start_date_time<span class="op">,</span> account_budget_proposal<span class="op">.</span>resource_name<span class="op">,</span> account_budget_proposal<span class="op">.</span>status"</span><span class="vr"><span class="op">,</span>
</span><span>					</span><span class="st">"start_date"</span><span class="vr"><span class="op">:</span> </span><span class="st">"2021-01-01"</span><span class="vr"><span class="op">,</span>
</span><span class="vr">				<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">			<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">		<span class="op">}</span></span><span class="vr"><span class="op">,</span>
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">func </span><span class="vr">GetSources<span class="op">(</span></span><span class="vr">c </span><span class="vr"><span class="op">*</span></span><span class="vr">gin<span class="op">.</span></span><span class="vr">Context<span class="op">)</span> </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	apiKey </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">c<span class="op">.</span></span><span class="vr">Param<span class="op">(</span></span><span class="st">"key"</span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">apiKey </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">os<span class="op">.</span></span><span class="vr">Getenv<span class="op">(</span></span><span class="st">"JITSU_KEY"</span><span class="vr"><span class="op">)</span> </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">403<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"Forbidden"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	sources<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">db<span class="op">.</span></span><span class="vr">Client<span class="op">.</span></span><span class="vr">Source<span class="op">.</span></span><span class="vr">Query<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">Where<span class="op">(</span></span><span class="vr">source<span class="op">.</span></span><span class="vr">HasProjectWith<span class="op">(</span></span><span class="vr">project<span class="op">.</span></span><span class="vr">Active<span class="op">(</span></span><span class="vr">true<span class="op">)</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span></span><span class="vr">All<span class="op">(</span></span><span class="vr">context<span class="op">.</span></span><span class="vr">Background<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	sourcesObj </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="vr"><span class="op">}</span>
</span><span class="kw">	for </span><span class="vr">_<span class="op">,</span> </span><span class="vr">v </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="kw">range </span><span class="vr">sources </span><span class="vr"><span class="op">{</span>
</span><span class="kw">		if </span><span class="vr">v<span class="op">.</span></span><span class="vr">Type </span><span class="vr"><span class="op">=</span></span><span class="vr"><span class="op">=</span> </span><span class="st">"fb"</span><span> </span><span class="vr"><span class="op">{</span>
</span><span class="vr">			parseFbSource<span class="op">(</span></span><span class="vr">v<span class="op">,</span> </span><span class="vr">sourcesObj<span class="op">)</span>
</span><span class="vr">		<span class="op">}</span>
</span><span class="kw">		if </span><span class="vr">v<span class="op">.</span></span><span class="vr">Type </span><span class="vr"><span class="op">=</span></span><span class="vr"><span class="op">=</span> </span><span class="st">"ga"</span><span> </span><span class="vr"><span class="op">{</span>
</span><span class="vr">			parseGaSource<span class="op">(</span></span><span class="vr">v<span class="op">,</span> </span><span class="vr">sourcesObj<span class="op">)</span>
</span><span class="vr">		<span class="op">}</span>
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">200<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"sources"</span><span class="vr"><span class="op">:</span> </span><span class="vr">sourcesObj<span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">type </span><span class="vr">GoogleOauthParams </span><span class="kw">struct </span><span class="vr"><span class="op">{</span>
</span><span class="vr">	CustomerId </span><span class="tp">string </span><span class="vr">`json<span class="op">:</span></span><span class="st">"customerId"</span><span> </span><span class="vr">binding<span class="op">:</span></span><span class="st">"required"</span><span>`
</span><span class="vr">	ManagerId </span><span> </span><span class="tp">string </span><span class="vr">`json<span class="op">:</span></span><span class="st">"managerId"</span><span>`
</span><span class="vr">	SourceName </span><span class="tp">string </span><span class="vr">`json<span class="op">:</span></span><span class="st">"sourceName"</span><span> </span><span class="vr">binding<span class="op">:</span></span><span class="st">"required"</span><span>`
</span><span class="vr"><span class="op">}</span>
</span><span>
</span><span class="kw">func </span><span class="vr">GetGoogleOauth<span class="op">(</span></span><span class="vr">c </span><span class="vr"><span class="op">*</span></span><span class="vr">gin<span class="op">.</span></span><span class="vr">Context<span class="op">)</span> </span><span class="vr"><span class="op">{</span>
</span><span class="kw">	var </span><span class="vr">params </span><span class="vr">GoogleOauthParams
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">c<span class="op">.</span></span><span class="vr">ShouldBindJSON<span class="op">(</span></span><span class="vr"><span class="op">&</span></span><span class="vr">params<span class="op">)</span></span><span class="vr"><span class="op">;</span> </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	claimsObj<span class="op">,</span> </span><span class="vr">ok </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">c<span class="op">.</span></span><span class="vr">Get<span class="op">(</span></span><span class="st">"project-claims"</span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr"><span class="op">!</span></span><span class="vr">ok </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"missing claims"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	claims<span class="op">,</span> </span><span class="vr">ok </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">claimsObj<span class="op">.</span></span><span class="vr"><span class="op">(</span></span><span class="vr"><span class="op">*</span></span><span class="vr">tokens<span class="op">.</span></span><span class="vr">ProjectToken<span class="op">)</span>
</span><span class="kw">	if </span><span class="vr"><span class="op">!</span></span><span class="vr">ok </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">400<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"invalid claims"</span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	state<span class="op">,</span> </span><span class="vr">_ </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">nanoid<span class="op">.</span></span><span class="vr">Nanoid<span class="op">(</span></span><span class="vr">5<span class="op">)</span>
</span><span class="vr">	_<span class="op">,</span> </span><span class="vr">err </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">db<span class="op">.</span></span><span class="vr">Client<span class="op">.</span></span><span class="vr">GoogleOauthState<span class="op">.</span></span><span class="vr">Create<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		SetID<span class="op">(</span></span><span class="vr">state<span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		SetCustomerID<span class="op">(</span></span><span class="vr">params<span class="op">.</span></span><span class="vr">CustomerId<span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		SetManagerID<span class="op">(</span></span><span class="vr">params<span class="op">.</span></span><span class="vr">ManagerId<span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		SetSourceName<span class="op">(</span></span><span class="vr">params<span class="op">.</span></span><span class="vr">SourceName<span class="op">)</span></span><span class="vr"><span class="op">.</span>
</span><span class="vr">		Save<span class="op">(</span></span><span class="vr">context<span class="op">.</span></span><span class="vr">Background<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">	if </span><span class="vr">err </span><span class="vr"><span class="op">!</span></span><span class="vr"><span class="op">=</span> </span><span class="tp">nil </span><span class="vr"><span class="op">{</span>
</span><span class="vr">		c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">500<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"error"</span><span class="vr"><span class="op">:</span> </span><span class="st">"failed to create state"</span><span class="vr"><span class="op">,</span> </span><span class="st">"message"</span><span class="vr"><span class="op">:</span> </span><span class="vr">err<span class="op">.</span></span><span class="vr">Error<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="kw">		return
</span><span class="vr">	<span class="op">}</span>
</span><span class="vr">	urlParams </span><span class="vr"><span class="op">:</span></span><span class="vr"><span class="op">=</span> </span><span class="vr">url<span class="op">.</span></span><span class="vr">Values<span class="op">{</span></span><span class="vr"><span class="op">}</span>
</span><span class="vr">	urlParams<span class="op">.</span></span><span class="vr">Add<span class="op">(</span></span><span class="st">"client_id"</span><span class="vr"><span class="op">,</span> </span><span class="vr">os<span class="op">.</span></span><span class="vr">Getenv<span class="op">(</span></span><span class="st">"GA_CLIENT_ID"</span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr">	urlParams<span class="op">.</span></span><span class="vr">Add<span class="op">(</span></span><span class="st">"redirect_uri"</span><span class="vr"><span class="op">,</span> </span><span class="vr">os<span class="op">.</span></span><span class="vr">Getenv<span class="op">(</span></span><span class="st">"GA_REDIRECT_URI"</span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr">	urlParams<span class="op">.</span></span><span class="vr">Add<span class="op">(</span></span><span class="st">"response_type"</span><span class="vr"><span class="op">,</span> </span><span class="st">"code"</span><span class="vr"><span class="op">)</span>
</span><span class="vr">	urlParams<span class="op">.</span></span><span class="vr">Add<span class="op">(</span></span><span class="st">"scope"</span><span class="vr"><span class="op">,</span> </span><span class="vr">"https<span class="op">:</span><span class="op">/</span><span class="op">/</span>www<span class="op">.</span>googleapis<span class="op">.</span>com<span class="op">/</span>auth<span class="op">/</span>adwords"</span><span class="vr"><span class="op">)</span>
</span><span class="vr">	urlParams<span class="op">.</span></span><span class="vr">Add<span class="op">(</span></span><span class="st">"access_type"</span><span class="vr"><span class="op">,</span> </span><span class="st">"offline"</span><span class="vr"><span class="op">)</span>
</span><span class="vr">	urlParams<span class="op">.</span></span><span class="vr">Add<span class="op">(</span></span><span class="st">"prompt"</span><span class="vr"><span class="op">,</span> </span><span class="st">"consent"</span><span class="vr"><span class="op">)</span>
</span><span class="vr">	urlParams<span class="op">.</span></span><span class="vr">Add<span class="op">(</span></span><span class="st">"state"</span><span class="vr"><span class="op">,</span> </span><span class="vr">claims<span class="op">.</span></span><span class="vr">ProjectId<span class="op">+</span></span><span class="vr">state<span class="op">)</span>
</span><span class="vr">	c<span class="op">.</span></span><span class="vr">JSON<span class="op">(</span></span><span class="vr">200<span class="op">,</span> </span><span class="vr">gin<span class="op">.</span></span><span class="vr">H<span class="op">{</span></span><span class="st">"status"</span><span class="vr"><span class="op">:</span> </span><span class="st">"ok"</span><span class="vr"><span class="op">,</span> </span><span class="st">"url"</span><span class="vr"><span class="op">:</span> </span><span class="vr">"https<span class="op">:</span><span class="op">/</span><span class="op">/</span>accounts<span class="op">.</span>google<span class="op">.</span>com<span class="op">/</span>o<span class="op">/</span>oauth2<span class="op">/</span>v2<span class="op">/</span>auth?"</span><span> </span><span class="vr"><span class="op">+</span> </span><span class="vr">urlParams<span class="op">.</span></span><span class="vr">Encode<span class="op">(</span></span><span class="vr"><span class="op">)</span></span><span class="vr"><span class="op">}</span></span><span class="vr"><span class="op">)</span>
</span><span class="vr"><span class="op">}</span>
</span>    </pre>
</body>
</html>